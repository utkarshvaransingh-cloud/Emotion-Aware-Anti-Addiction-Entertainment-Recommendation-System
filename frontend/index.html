<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RecSys Premium Hub</title>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #0f172a;
      --card-bg: #1e293b;
      --accent-color: #3b82f6;
      --text-primary: #f8fafc;
      --text-secondary: #94a3b8;
      --success: #10b981;
      --danger: #ef4444;
    }

    body {
      font-family: 'Outfit', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-primary);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1 {
      font-weight: 600;
      letter-spacing: -1px;
      margin-bottom: 2rem;
    }

    .container {
      width: 100%;
      max-width: 1100px;
    }

    /* Header with User Info */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      gap: 15px;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
      background: rgba(30, 41, 59, 0.7);
      padding: 10px 20px;
      border-radius: 30px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 1.1rem;
    }

    .user-name {
      font-weight: 500;
    }

    .logout-btn {
      background: transparent;
      border: 1px solid rgba(239, 68, 68, 0.5);
      color: #f87171;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-family: inherit;
      font-size: 0.85rem;
      transition: all 0.2s;
    }

    .logout-btn:hover {
      background: rgba(239, 68, 68, 0.1);
      border-color: #ef4444;
    }

    /* Control Panel */
    .controls {
      background: rgba(30, 41, 59, 0.7);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.05);
      padding: 25px;
      border-radius: 16px;
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      margin-bottom: 30px;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    label {
      color: var(--text-secondary);
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    select {
      background: var(--bg-color);
      color: var(--text-primary);
      border: 1px solid #334155;
      padding: 10px 15px;
      border-radius: 8px;
      font-family: inherit;
      min-width: 200px;
      cursor: pointer;
      transition: border-color 0.2s;
    }

    select:focus {
      outline: none;
      border-color: var(--accent-color);
    }

    .btn {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
    }

    /* Grid */
    #recList {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    /* Card */
    .card {
      background: var(--card-bg);
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.05);
      transition: transform 0.3s ease;
      position: relative;
    }

    .card:hover {
      transform: translateY(-5px);
      border-color: rgba(255, 255, 255, 0.1);
    }

    .poster-container {
      width: 100%;
      height: 380px;
      background: linear-gradient(45deg, #334155, #475569);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      position: relative;
      overflow: hidden;
    }

    .poster-container img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }

    .card:hover .poster-container img {
      transform: scale(1.05);
    }

    .poster-placeholder {
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, #334155, #475569);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
    }

    .card-content {
      padding: 15px;
    }

    .card h3 {
      margin: 0 0 5px 0;
      font-size: 1.1rem;
    }

    .meta {
      color: var(--text-secondary);
      font-size: 0.8em;
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .explanation {
      background: rgba(59, 130, 246, 0.1);
      color: #60a5fa;
      padding: 8px;
      border-radius: 6px;
      font-size: 0.85em;
      line-height: 1.4;
      border-left: 3px solid var(--accent-color);
    }

    /* Special Cards */
    .break-card {
      border: 1px solid var(--danger);
      background: rgba(239, 68, 68, 0.05);
    }

    .break-card .poster-container {
      background: linear-gradient(45deg, #7f1d1d, #991b1b);
    }

    .break-card .explanation {
      background: rgba(239, 68, 68, 0.1);
      color: #f87171;
      border-left-color: var(--danger);
    }

    .loading {
      text-align: center;
      color: var(--text-secondary);
      width: 100%;
      grid-column: 1 / -1;
      padding: 50px;
    }

    /* Health Meter */
    .health-section {
      margin-bottom: 25px;
      width: 100%;
    }

    .health-bar-container {
      width: 100%;
      height: 12px;
      background: #1e293b;
      border-radius: 6px;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.1);
      margin-top: 10px;
    }

    .health-bar {
      height: 100%;
      width: 0%;
      transition: width 0.5s ease, background-color 0.5s ease;
      background-color: var(--success);
    }

    .health-stats {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-top: 5px;
    }

    /* Hard Break Overlay */
    #breakOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(10px);
      z-index: 9999;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 20px;
    }

    #breakOverlay h2 {
      font-size: 3rem;
      margin-bottom: 1rem;
      color: var(--danger);
    }

    #breakOverlay p {
      max-width: 500px;
      font-size: 1.2rem;
      margin-bottom: 2rem;
      color: var(--text-secondary);
    }

    .watch-btn {
      width: 100%;
      background: transparent;
      border: 1px solid rgba(59, 130, 246, 0.5);
      color: var(--accent-color);
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85em;
      font-weight: 500;
      margin-bottom: 10px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .watch-btn:hover {
      background: rgba(59, 130, 246, 0.1);
      border-color: var(--accent-color);
    }

    /* Fatigue debug info */
    .fatigue-debug {
      background: rgba(0, 0, 0, 0.3);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-top: 5px;
    }
  </style>
</head>

<body>

  <div class="container">
    <div class="header">
      <h1>üçø Entertainment <span style="color:var(--accent-color)">Engine</span></h1>

      <div class="user-info" id="userInfoSection">
        <div class="user-avatar" id="userAvatar">?</div>
        <span class="user-name" id="userName">Guest</span>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>

    <!-- User Controls Section -->
    <div class="controls" style="border-left: 4px solid var(--accent-color);">
      <h3>üéØ Your Session</h3>
      <div class="input-group">
        <label>Current Vibe</label>
        <select id="emotion">
          <option value="happy">Happy (High Energy)</option>
          <option value="sad">Sad (Need Cheer Up)</option>
          <option value="bored">Bored (Need Excitement)</option>
          <option value="anxious">Anxious (Need Calm)</option>
          <option value="neutral">Neutral (Balanced)</option>
        </select>
      </div>

      <div class="input-group" style="min-width: 180px;">
        <label>Session Time: <span id="timeVal" style="color:var(--accent-color)">30</span> min</label>
        <input type="range" id="sessionTime" min="0" max="200" value="30"
          oninput="document.getElementById('timeVal').innerText = this.value">
        <small style="color:var(--text-secondary); font-size:0.7em;">~140min triggers Break</small>
      </div>

      <div class="input-group">
        <label>Time of Day</label>
        <select id="timeOfDay">
          <option value="morning">Morning</option>
          <option value="afternoon">Afternoon</option>
          <option value="evening" selected>Evening</option>
          <option value="night">Night (‚Üë Fatigue)</option>
        </select>
      </div>
    </div>

    <!-- content Access Section -->
    <div class="controls" style="border-left: 4px solid var(--success);">
      <h3>üîé Explore Genres</h3>
      <div class="input-group">
        <label>Filter By Genre</label>
        <select id="genreFilter">
          <option value="all">All Genres (AI Recommended)</option>
          <option value="action">Action</option>
          <option value="romance">Romance</option>
          <option value="comedy">Comedy</option>
          <option value="sci-fi">Sci-Fi</option>
          <option value="thriller">Thriller</option>
          <option value="doc">Documentary</option>
          <option value="fantasy">Fantasy üßô‚Äç‚ôÇÔ∏è</option>
          <option value="horror">Horror üëª</option>
          <option value="mystery">Mystery üïµÔ∏è‚Äç‚ôÄÔ∏è</option>
          <option value="drama">Drama üé≠</option>
          <option value="adventure">Adventure üó∫Ô∏è</option>
          <option value="animation">Animation üé®</option>
          <option value="musical">Musical üéµ</option>
          <option value="crime">Crime üöì</option>
        </select>
      </div>

      <div class="input-group" style="flex-direction: row; align-items: flex-end;">
        <button class="btn" onclick="getRecs()">Find Content</button>
        <button class="btn" style="background: #475569;" onclick="getRecs()">üîÑ Refresh</button>
      </div>
    </div>

    <!-- Health Meter -->
    <div class="health-section">
      <label>Your Digital Health Status</label>
      <div class="health-bar-container">
        <div id="healthBar" class="health-bar" style="width: 20%;"></div>
      </div>
      <div class="health-stats">
        <span id="healthLabel">Status: Fresh</span>
        <span id="sessionLabel">Session: 30 min</span>
      </div>
      <div class="fatigue-debug" id="fatigueDebug" style="display: none;"></div>
    </div>

    <div id="recList"></div>
  </div>

  <script>
    // TMDB Image Base URL
    const TMDB_IMAGE_BASE = 'https://image.tmdb.org/t/p/w500';

    // Check login status
    const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
    let userId = 'u_1';

    if (!currentUser) {
      // Redirect to login page
      window.location.href = 'login.html';
    } else {
      userId = currentUser.user_id || 'u_1';
      document.getElementById('userName').textContent = currentUser.name || currentUser.email.split('@')[0];
      document.getElementById('userAvatar').textContent = (currentUser.name || currentUser.email)[0].toUpperCase();
    }

    function logout() {
      localStorage.removeItem('currentUser');
      window.location.href = 'login.html';
    }

    const urlParams = new URLSearchParams(window.location.search);
    let currentSessionMinutes = parseInt(urlParams.get('session')) || 0;

    if (currentSessionMinutes > 0) {
      document.getElementById('sessionTime').value = currentSessionMinutes;
      document.getElementById('timeVal').innerText = currentSessionMinutes;
    }

    function watchMovie(movieTitle, duration, movieId, tmdbId, posterPath) {
      const emotion = document.getElementById('emotion').value;
      const timeOfDay = document.getElementById('timeOfDay').value;

      window.location.href = `watch.html?title=${encodeURIComponent(movieTitle)}&duration=${duration}&id=${movieId}&tmdb=${tmdbId || ''}&poster=${encodeURIComponent(posterPath || '')}&emotion=${emotion}&time=${timeOfDay}&user=${userId}&session=${currentSessionMinutes}`;
    }

    async function getRecs() {
      const emotion = document.getElementById('emotion').value;
      const genreFilter = document.getElementById('genreFilter').value;
      const sessionTime = document.getElementById('sessionTime').value;
      const timeOfDay = document.getElementById('timeOfDay').value;
      const listDiv = document.getElementById('recList');

      listDiv.innerHTML = '<div class="loading">Analyzing your state and ranking content...</div>';

      try {
        const response = await fetch('http://127.0.0.1:8080/recommend', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user_id: userId,
            context: {
              time_of_day: timeOfDay,
              device_type: "browser",
              location: "web",
              session_minutes: parseInt(sessionTime)
            },
            emotion: { label: emotion },
            genre_filter: genreFilter === "all" ? null : genreFilter
          })
        });
        if (!response.ok) throw new Error('API Error');

        const data = await response.json();
        listDiv.innerHTML = '';

        updateHealthMeter(data.meta || {});

        if (data.recommendations.length === 0) {
          listDiv.innerHTML = '<div class="loading">No recommendations found. Try a different profile!</div>';
          return;
        }

        data.recommendations.forEach(item => {
          const isBreak = item.item_id === 'BREAK_ACTIVITY';
          const card = document.createElement('div');
          card.className = isBreak ? 'card break-card' : 'card';
          const category = item.category ? item.category.toUpperCase() : 'WELLBEING';

          // Use real TMDB poster if available
          let posterHtml;
          if (isBreak) {
            posterHtml = `<div class="poster-placeholder">üßò</div>`;
          } else if (item.poster_path) {
            posterHtml = `<img src="${TMDB_IMAGE_BASE}${item.poster_path}" alt="${item.title}" 
                            onerror="this.parentElement.innerHTML='<div class=\\'poster-placeholder\\'>üé¨</div>'">`;
          } else {
            posterHtml = `<div class="poster-placeholder">üé¨</div>`;
          }

          const matchPercent = Math.min(100, Math.round(item.score * 100));
          const duration = Math.floor(Math.random() * 90) + 90;

          card.innerHTML = `
            <div class="poster-container">
               ${posterHtml}
            </div>
            <div class="card-content">
                ${!isBreak ? `<button class="watch-btn" onclick="watchMovie('${item.title.replace(/'/g, "\\'")}', ${duration}, '${item.item_id}', '${item.tmdb_id || ''}', '${(item.poster_path || '').replace(/'/g, "\\'")}')">
                  <span>‚ñ∂</span> Watch Now
                </button>` : ''}
                <div class="meta">
                    <span style="background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px;">${category}</span>
                    <span style="color:var(--success)">${matchPercent}% Match</span>
                </div>
                <h3>${item.title}</h3>
                ${!isBreak ? `<small style="color: var(--text-secondary);">‚è±Ô∏è ${duration} min</small><br>` : ''}
                <div class="explanation">
                    ${item.explanation}
                </div>
            </div>
          `;
          listDiv.appendChild(card);
        });

      } catch (err) {
        listDiv.innerHTML = `<div class="loading" style="color:var(--danger)">
                    <b>Connection Failed to http://127.0.0.1:8080</b><br><br>
                    1. Is the backend server running?<br>
                    2. Check the console for "SUCCESS: Recommendation Engine Ready".<br><br>
                    <small>Try visiting: <a href="http://127.0.0.1:8080/health" target="_blank">http://127.0.0.1:8080/health</a></small>
                </div>`;
        console.error(err);
      }
    }

    function updateHealthMeter(meta) {
      const bar = document.getElementById('healthBar');
      const label = document.getElementById('healthLabel');
      const debug = document.getElementById('fatigueDebug');

      const intervention = meta.fatigue_intervention;
      const fatigueScore = meta.fatigue_score || 0;
      const metrics = meta.fatigue_metrics || {};

      // Display fatigue score from API
      const percent = Math.min(100, Math.round(fatigueScore * 100));
      bar.style.width = percent + '%';

      // Show debug info
      debug.style.display = 'block';
      debug.innerHTML = `Fatigue Score: ${(fatigueScore * 100).toFixed(1)}% | 
                         Session: ${metrics.session_minutes || 0}min | 
                         Repetition: ${((metrics.repetition || 0) * 100).toFixed(0)}% | 
                         Intervention: ${intervention || 'none'}`;

      const sessionMinutes = document.getElementById('sessionTime').value;

      if (intervention === 'hard_break' || fatigueScore >= 0.84) {
        bar.style.backgroundColor = 'var(--danger)';
        label.innerHTML = 'Status: Critical Fatigue üö®';
        document.getElementById('breakOverlay').style.display = 'flex';
      } else if (intervention === 'soft_break' || fatigueScore > 0.6) {
        bar.style.backgroundColor = '#f59e0b';
        label.innerHTML = 'Status: Feeling Tired ‚ö†Ô∏è';
        document.getElementById('breakOverlay').style.display = 'none';
      } else if (intervention === 'diversify' || fatigueScore > 0.4) {
        bar.style.backgroundColor = '#fbbf24';
        label.innerHTML = 'Status: Warning üëì';
        document.getElementById('breakOverlay').style.display = 'none';
      } else {
        bar.style.backgroundColor = 'var(--success)';
        label.innerHTML = 'Status: Fresh ‚úÖ';
        document.getElementById('breakOverlay').style.display = 'none';
      }

      document.getElementById('sessionLabel').innerText = `Session: ${sessionMinutes} min`;
    }

    function closeBreak() {
      document.getElementById('breakOverlay').style.display = 'none';
      document.getElementById('sessionTime').value = 0;
      document.getElementById('timeVal').innerText = 0;
      getRecs();
    }
  </script>

  <!-- Hard Break Overlay -->
  <div id="breakOverlay">
    <h2>Take a Deep Breath üßò</h2>
    <p>You've been enjoying content for quite a while. To prevent fatigue and keep your experience premium, we've paused
      recommendations for a few minutes.</p>
    <button class="btn" onclick="closeBreak()">I've rested, let's resume</button>
  </div>
</body>

</html>